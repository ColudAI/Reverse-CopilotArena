# Copilot Arena API 文档

本文档详细介绍了 Copilot Arena 后端服务的 RESTful API。所有 API 请求的 `Content-Type` 均为 `application/json`，并且响应体也为 **JSON 格式**。
> CopilotArena逆向无疑是任何逆向小白的入门练习题
>
> 注意：部分上传数据的api我们**不会开放**，避免CopilotArena竞技场遭到恶意污染，**请各位不要恶意逆向！！**

**基础 URL**: `https://code-arena.fly.dev`

## 1. 代码交互 API

这类 API 用于获取和提交代码生成与编辑的相关数据。

### 1.1 获取代码补全建议 (Completion Pair)

当用户在编辑器中输入代码时，调用此 API 以获取一对代码补全建议。

-   **端点**: `/create_pair`
-   **方法**: `POST`
-   **描述**: 根据给定的代码前缀（`prefix`）和后缀（`suffix`），生成两个由不同模型提供的代码补全建议。

**请求体 (Request Body):**

```json
{
  "pairId": "string",
  "userId": "string",
  "prefix": "string",
  "suffix": "string",
  "midSpan": "boolean",
  "temperature": "number",
  "maxTokens": "integer",
  "topP": "number",
  "maxLines": "integer",
  "privacy": "string",
  "modelTags": ["string"]
}
```

**字段说明:**

| 字段          | 类型      | 描述                                                                          | 示例                                     |
|---------------|-----------|-------------------------------------------------------------------------------|------------------------------------------|
| `pairId`      | `string`  | **必需**. 客户端生成的唯一 ID，用于标识这次请求。                                   | `"c7a5...-..."` (UUID)                    |
| `userId`      | `string`  | **必需**. 用户的唯一标识符，通常是客户端的机器 ID。                                 | `"f8b2...-..."` (UUID 或固定 ID)           |
| `prefix`      | `string`  | **必需**. 光标前的所有代码上下文。                                                | `"def my_function():\n    \"\"\"Docstring\"\"\"\n"` |
| `suffix`      | `string`  | 光标后的所有代码上下文。                                                      | `"\n\nprint('Hello')"`                   |
| `midSpan`     | `boolean` | `prefix` 的末尾是否不为空白字符。用于模型判断是否在行中间进行补全。                | `true`                                   |
| `temperature` | `number`  | 控制生成文本的随机性，值越高越随机。                                           | `0.5`                                    |
| `maxTokens`   | `integer` | 生成内容的最大 token 数量。                                                    | `512`                                    |
| `topP`        | `number`  | 核心采样（Nucleus sampling）参数。                                             | `0.9`                                    |
| `maxLines`    | `integer` | 限制生成的最大行数。                                                          | `10`                                     |
| `privacy`     | `string`  | 隐私设置，可以是 `"Private"`, `"Research"`, `"Debug"`。                     | `"Private"`                              |
| `modelTags`   | `array`   | 用于筛选模型的标签数组（可选）。                                               | `[]`                                     |

**成功响应 (Success Response):**

```json
{
  "pairId": "c7a5...-...",
  "completionItems": [
    {
      "completionId": "comp_id_1",
      "userId": "f8b2...-...",
      "prompt": "...",
      "timestamp": 167...000,
      "completion": "    pass\n",
      "model": "model-alpha"
    },
    {
      "completionId": "comp_id_2",
      "userId": "f8b2...-...",
      "prompt": "...",
      "timestamp": 167...000,
      "completion": "    return None\n",
      "model": "model-beta"
    }
  ]
}
```

### 1.2 获取代码编辑建议 (Edit Pair)

当用户选中一段代码并提供修改指令时，调用此 API 以获取一对代码编辑建议。

-   **端点**: `/create_edit_pair`
-   **方法**: `POST`
-   **描述**: 根据用户的指令（`userInput`）和待编辑的代码（`codeToEdit`），生成两个由不同模型提供的完整代码块替换建议。

**请求体 (Request Body):**

```json
{
  "pairId": "string",
  "userId": "string",
  "prefix": "string",
  "suffix": "string",
  "codeToEdit": "string",
  "userInput": "string",
  "maxLines": "integer",
  "privacy": "string",
  "language": "string"
}
```

**字段说明:**

| 字段           | 类型      | 描述                                     | 示例                                       |
|----------------|-----------|------------------------------------------|--------------------------------------------|
| `pairId`       | `string`  | **必需**. 客户端生成的唯一 ID。            | `"a1b2...-..."` (UUID)                      |
| `userId`       | `string`  | **必需**. 用户的唯一标识符。               | `"f8b2...-..."` (UUID 或固定 ID)             |
| `prefix`       | `string`  | 选中区域之前的代码上下文。                 | `"import os\n\n"`                          |
| `suffix`       | `string`  | 选中区域之后的代码上下文。                 | `"\nmain()"`                               |
| `codeToEdit`   | `string`  | **必需**. 用户在编辑器中选中的待编辑代码块。 | `"for i in range(5):\n    print(i)"`       |
| `userInput`    | `string`  | **必需**. 用户输入的自然语言编辑指令。     | `"将这个循环改为列表推导式"`                  |
| `maxLines`     | `integer` | 限制生成的最大行数。                     | `50`                                       |
| `privacy`      | `string`  | 隐私设置。                               | `"Private"`                                |
| `language`     | `string`  | 当前代码的语言（可选）。                   | `"python"`                                 |

**成功响应 (Success Response):**

```json
{
  "pairId": "a1b2...-...",
  "responseItems": [
    {
      "responseId": "resp_id_1",
      "userId": "f8b2...-...",
      "prompt": "...",
      "timestamp": 167...000,
      "response": "[print(i) for i in range(5)]",
      "model": "model-edit-x"
    },
    {
      "responseId": "resp_id_2",
      "userId": "f8b2...-...",
      "prompt": "...",
      "timestamp": 167...000,
      "response": "numbers = [i for i in range(5)]\nprint(numbers)",
      "model": "model-edit-y"
    }
  ]
}
```

---

## 2. 用户管理 API

这类 API 用于处理用户账户的创建、验证和数据查询。

### 2.1 用户注册/更新

创建一个新用户或更新现有用户信息。

-   **端点**: `/users`
-   **方法**: `PUT`
-   **描述**: 使用 `userId` 作为唯一标识来创建或更新用户。如果提供的 `username` 已被占用，会返回 `409 Conflict` 错误。

**请求体 (Request Body):**

```json
{
  "userId": "string",
  "username": "string",
  "password": "string",
  "metadata": "object"
}
```

**字段说明:**

| 字段       | 类型     | 描述                               | 示例                  |
|------------|----------|------------------------------------|-----------------------|
| `userId`   | `string` | **必需**. 用户的唯一标识符。         | `"f8b2...-..."`         |
| `username` | `string` | **必需**. 用户选择的唯一昵称。       | `"testuser"`          |
| `password` | `string` | **必需**. 用户密码。                 | `"a_strong_password"` |
| `metadata` | `object` | 用于存储额外信息的元数据对象（可选）。 | `{}`                  |

**成功响应 (Success Response):** `200 OK` 并返回一个确认对象。

### 2.2 用户验证 (登录)

验证用户的凭据。

-   **端点**: `/users/authenticate`
-   **方法**: `POST`
-   **描述**: 验证 `username` 和 `password` 是否匹配。如果凭据错误，会返回 `401 Unauthorized`。

**请求体 (Request Body):**

```json
{
  "userId": "string",
  "username": "string",
  "password": "string"
}
```

**成功响应 (Success Response):**

```json
{
  "user": {
    "username": "testuser",
    // ... 其他用户信息
  }
}
```

### 2.3 获取用户分数

查询指定用户的历史评分数据。

-   **端点**: `/user_scores`
-   **方法**: `POST`
-   **描述**: 返回一个包含该用户评分历史的数组，可用于绘制排名变化图表。

**请求体 (Request Body):**

```json
{
  "userId": "string"
}
```

**成功响应 (Success Response):**

```json
[
  [
    { "model": "model-alpha", "elo": 1520 },
    { "model": "model-beta", "elo": 1480 }
  ],
  [
    { "model": "model-alpha", "elo": 1525 },
    { "model": "model-beta", "elo": 1475 }
  ]
  // ... 更多历史数据
]
```

### 2.4 获取用户投票数

查询指定用户的总投票（选择）次数。

-   **端点**: `/user_vote_count`
-   **方法**: `POST`
-   **描述**: 返回一个包含用户总投票数的对象。

**请求体 (Request Body):**

```json
{
  "userId": "string"
}
```

**成功响应 (Success Response):**

```json
{
  "voteCount": 123
}
```

---

**注意**: 文档中未包含 `/add_completion_outcome` 和 `/add_edit_outcome` 等用于提交用户选择结果的 API，因为它们主要由客户端在用户做出选择后内部调用，对于第三方开发者来说，上述获取建议和管理用户的 API 是核心。如果需要，可以按照同样的格式进行补充。
